fitStats <- function(y,y.pred) {
  tp=0; fp=0; tn=0; fn=0;
  for (i in 1:length(y)){
    if (y[i]==y.pred[i]) {
      if (y[i]==1) tp=tp+1
      else tn=tn+1
    }
    else {
      if (y[i]==0) fn=fn+1
      else fp=fp+1
    }
  }
  accuracy=(tp+tn)/length(y)
  precision=tp/(tp+fp)
  recall=tp/(tp+fn)
  
  if (precision + recall == 0) f1.score = 0
  else f1.score=2*(precision*recall)/(precision+recall)
  
  stat <- c(accuracy,precision,recall,f1.score)
  names(stat) <- c("accuracy","precision","recall","f1.score")
  stat
}
dat <- read.csv("C:/Users/user/Desktop/proga/R/cmf/learn/hw5/AD_comp_train.csv", header = TRUE, stringsAsFactors = FALSE)
X=cbind(dat[,1],dat[,2])
X=log(X+4)
X=cbind(X,(X[,2]/X[,1])^(3))
y=dat[,3]
m <- nrow(X)
# ?????? ??????????? ??????????
anom.obs <- (1:m)[y==1]; la <- length(anom.obs)
m.cv <- round(0.2*(m-la)) + la; m.train <- m - m.cv
# ?????? ???????????? ? ????????? ???????
cv.obs <- c( sample((1:m)[-anom.obs],size=m.cv-la,replace=FALSE),
             anom.obs )
train.obs <- (1:m)[-cv.obs]
# ?????????? ???????
X.train <- X[train.obs,]; X.cv <- X[cv.obs,]
y.train <- y[train.obs]; y.cv <- y[cv.obs]
# X.train=log(X.train+1); X.cv=log(X.cv+1)

# ?????? ??????????
mu <- apply(X.train,2,mean)
sigma <- apply(X.train,2,sd)
# ??????? ?????????????
p <- function(X,mu,sigma) {
  m <- nrow(X); n <- ncol(X)
  prob <- matrix(nrow=m,ncol=n)
  for (j in 1:n) prob[,j] <- dnorm(X[,j],mu[j],sigma[j])
  apply(prob,1,prod)
}
# ??????????? ??????????????
prob.train <- p(X.train,mu,sigma)
prob.cv <- p(X.cv,mu,sigma)
pr <- range(prob.cv) # ??????? ????????? ???????? ????
res <- NULL # ? ??? ????? ??????????? ?????????? ?????????????
# ??? ??????? ?????????? ???????????? ??????? ????????????
# ??????? ??? ???????????? ???????? ???? ? ?????????? ??? ? ??????
for (eps in seq(pr[1], pr[2], length = 1000)) {
  y.pred <- 1*(prob.cv<=eps)
  res <- rbind(res, c(eps,fitStats(y.pred,y.cv)) )
}
dimnames(res)[[2]][1] <- "epsilon" # ?????????
# ????? ???????? ??????????? ????
j <- which.max(res[,"f1.score"])
eps <- res[j,"epsilon"]
# ????????????? ???????
y.pred <- 1*(prob.cv<eps)
print(y.pred)













dat2 <- read.csv("C:/Users/user/Desktop/proga/R/cmf/learn/hw5/AD_comp_test.csv", header = TRUE, stringsAsFactors = FALSE)
X2=cbind(dat2[,1],dat2[,2])
X2=log(X2+4)
X2=cbind(X2,(dat2[,2]/dat2[,1])^(3))
mu2 <- apply(X2,2,mean)
sigma2 <- apply(X2,2,sd)
prob2 <- p(X2,mu2,sigma2)
y2 <- 1*(prob2<eps)
print(y2)
library(xlsx)
library(kernlab)
library(rJava)
write.csv(y2,"C:/Users/user/Desktop/proga/R/cmf/learn/hw5/ypred.csv",row.names=FALSE)